{% extends "base.html" %}

{% block title %}דוחות - מערכת ניהול משלוחי מנות{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> דוחות
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">דוחות זמינים</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for view in views %}
                <a href="#" class="list-group-item list-group-item-action view-link" 
                   data-view="{{ view['name'] }}">
                    <i class="fas fa-chart-line me-2"></i> {{ view['name'] }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="reportName">בחר דוח מהרשימה</h5>
                <div>
                    <button class="btn btn-light btn-sm" id="exportBtn" style="display: none;" onclick="exportView()">
                        <i class="fas fa-download"></i> יצא ל-CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="reportContainer">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>בחר דוח כדי להציג את הנתונים</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Descriptions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> תיאור הדוחות
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-users text-primary"></i> v_accounts_summary</h6>
                        <p class="small">סיכום חשבונות - סה"כ הזמנות, סכומים והנחות לפי משפחה</p>
                        
                        <h6><i class="fas fa-balance-scale text-success"></i> v_families_balance</h6>
                        <p class="small">איזון משפחות - כמה שלחו לעומת כמה קיבלו</p>
                        
                        <h6><i class="fas fa-receipt text-info"></i> v_family_receipts</h6>
                        <p class="small">קבלות משפחות - פירוט משלוחים שהתקבלו</p>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="fas fa-building text-warning"></i> v_packages_per_building</h6>
                        <p class="small">חלוקת מנות לפי בניין ורחוב</p>
                        
                        <h6><i class="fas fa-sync text-danger"></i> v_autoreturn_activity</h6>
                        <p class="small">פעילות החזרה אוטומטית</p>
                        
                        <h6><i class="fas fa-list text-secondary"></i> v_orders_summary</h6>
                        <p class="small">סיכום הזמנות כללי</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentView = null;

$(document).ready(function() {
    $('.view-link').click(function(e) {
        e.preventDefault();
        currentView = $(this).data('view');
        loadViewData();
        
        // Highlight selected view
        $('.view-link').removeClass('active');
        $(this).addClass('active');
    });
});

function loadViewData() {
    if (!currentView) return;
    
    $.ajax({
        url: `/api/view-data/${currentView}`,
        method: 'GET',
        success: function(response) {
            $('#reportName').text(currentView);
            $('#exportBtn').show();
            renderReport(response.data);
        },
        error: function() {
            alert('שגיאה בטעינת הדוח');
        }
    });
}

function renderReport(data) {
    if (!data || data.length === 0) {
        $('#reportContainer').html('<div class="alert alert-warning">אין נתונים להצגה</div>');
        return;
    }
    
    const columns = Object.keys(data[0]);
    
    let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
    html += '<thead class="table-dark"><tr>';
    
    columns.forEach(col => {
        html += `<th>${col}</th>`;
    });
    
    html += '</tr></thead><tbody>';
    
    data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
            let value = row[col];
            if (value === null) value = '<span class="text-muted">NULL</span>';
            if (typeof value === 'boolean') value = value ? '✓' : '✗';
            if (typeof value === 'number' && col.includes('amount')) {
                value = value.toFixed(2) + ' ש"ח';
            }
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    // Add summary if applicable
    if (data.length > 0 && columns.some(col => col.includes('amount'))) {
        const totalCol = columns.find(col => col.includes('total_amount'));
        if (totalCol) {
            const total = data.reduce((sum, row) => sum + (parseFloat(row[totalCol]) || 0), 0);
            html += `<div class="alert alert-info mt-3">
                        <strong>סה"כ:</strong> ${total.toFixed(2)} ש"ח
                     </div>`;
        }
    }
    
    $('#reportContainer').html(html);
}

function exportView() {
    if (!currentView) return;
    window.location.href = `/api/export-view/${currentView}`;
}
</script>
{% endblock %}
